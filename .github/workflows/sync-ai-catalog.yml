name: Sync AI Catalog from AI_list.json

on:
  # Manual trigger
  workflow_dispatch:
  
  # Scheduled check every 6 hours
  schedule:
    - cron: '0 */6 * * *'

jobs:
  sync-catalog:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow writing to repository
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Refresh Dropbox Access Token (if needed)
        id: refresh_token
        env:
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
        run: |
          # Function to refresh access token
          refresh_access_token() {
            if [ -z "$DROPBOX_APP_KEY" ] || [ -z "$DROPBOX_APP_SECRET" ] || [ -z "$DROPBOX_REFRESH_TOKEN" ]; then
              echo "‚ö†Ô∏è  Refresh token credentials not configured. Using access token directly."
              echo "refresh_needed=false" >> $GITHUB_OUTPUT
              return
            fi
            
            echo "üîÑ Refreshing Dropbox access token..."
            RESPONSE=$(curl -s -X POST https://api.dropbox.com/oauth2/token \
              -u "$DROPBOX_APP_KEY:$DROPBOX_APP_SECRET" \
              -d grant_type=refresh_token \
              -d refresh_token="$DROPBOX_REFRESH_TOKEN")
            
            if echo "$RESPONSE" | grep -q "access_token"; then
              NEW_TOKEN=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['access_token'])")
              echo "‚úÖ Successfully refreshed access token"
              echo "access_token=$NEW_TOKEN" >> $GITHUB_OUTPUT
              echo "refresh_needed=true" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è  Failed to refresh token, will try with existing access token"
              echo "Response: $RESPONSE"
              echo "refresh_needed=false" >> $GITHUB_OUTPUT
            fi
          }
          
          refresh_access_token
      
      - name: Download AI_list.json from Dropbox
        env:
          DROPBOX_ACCESS_TOKEN: ${{ steps.refresh_token.outputs.access_token || secrets.DROPBOX_ACCESS_TOKEN }}
        run: |
          mkdir -p "Finance Public"
          
          # Check if token is set
          if [ -z "$DROPBOX_ACCESS_TOKEN" ]; then
            echo "‚ùå Error: DROPBOX_ACCESS_TOKEN secret is not set in GitHub repository settings"
            echo "Please go to: Settings > Secrets and variables > Actions > New repository secret"
            echo "Name: DROPBOX_ACCESS_TOKEN"
            echo "Value: [Your Dropbox access token]"
            exit 1
          fi
          
          # Function to download file
          download_file() {
            local PATH_ARG="$1"
            HTTP_CODE=$(curl -s -o "Finance Public/AI_list.json" -w "%{http_code}" \
              -X POST https://content.dropboxapi.com/2/files/download \
              --header "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
              --header "Dropbox-API-Arg: {\"path\": \"$PATH_ARG\"}")
            
            if [ "$HTTP_CODE" = "401" ]; then
              echo "‚ö†Ô∏è  Access token expired (HTTP 401)"
              return 1
            fi
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "Failed to download (HTTP $HTTP_CODE)"
              return 1
            fi
            
            return 0
          }
          
          # Try AI_list.json first
          if ! download_file "/Finance Public/AI_list.json"; then
            echo "Failed to download AI_list.json, trying alternative path..."
            # Try alternative path
            if ! download_file "/Finance Public/AI  - AI.json"; then
              echo "‚ùå Error: Failed to download from Dropbox"
              echo "Response content:"
              cat "Finance Public/AI_list.json" || echo "No response file"
              echo ""
              echo "If you see HTTP 401, make sure you have set up refresh token:"
              echo "1. Run: python3 scripts/get_refresh_token.py"
              echo "2. Add all 4 secrets to GitHub: DROPBOX_ACCESS_TOKEN, DROPBOX_APP_KEY, DROPBOX_APP_SECRET, DROPBOX_REFRESH_TOKEN"
              exit 1
            fi
          fi
          
          # Verify it's valid JSON
          if ! python3 -m json.tool "Finance Public/AI_list.json" > /dev/null 2>&1; then
            echo "Error: Downloaded file is not valid JSON"
            echo "First 500 characters:"
            head -c 500 "Finance Public/AI_list.json"
            exit 1
          fi
          
          echo "‚úÖ Successfully downloaded AI_list.json from Dropbox"
      
      - name: Run catalog sync script
        run: |
          node scripts/sync_from_ai_list.js
      
      - name: Check for changes
        id: check_changes
        run: |
          git add "remake AI Catalog/js/smt.js"
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in catalog"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in catalog"
            git status --short
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "ai-catalog-sync-bot"
          git config user.email "actions@github.com"
          git commit -m "Auto-sync: Update AI catalog from AI_list.json - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git pull origin main --rebase || true
          git push origin main
      
      - name: Upload sync logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs
          path: |
            sync-*.log
          retention-days: 7
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå AI Catalog sync failed! Check the logs for details."

