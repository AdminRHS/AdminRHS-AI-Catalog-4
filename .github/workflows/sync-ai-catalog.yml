name: Sync AI Catalog from AI_list.json

on:
  # Manual trigger
  workflow_dispatch:
  
  # Scheduled check every 6 hours
  schedule:
    - cron: '0 */6 * * *'

jobs:
  sync-catalog:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow writing to repository
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Download AI_list.json from Dropbox
        env:
          DROPBOX_ACCESS_TOKEN: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
        run: |
          mkdir -p "Finance Public"
          
          # Check if token is set
          if [ -z "$DROPBOX_ACCESS_TOKEN" ]; then
            echo "❌ Error: DROPBOX_ACCESS_TOKEN secret is not set in GitHub repository settings"
            echo "Please go to: Settings > Secrets and variables > Actions > New repository secret"
            echo "Name: DROPBOX_ACCESS_TOKEN"
            echo "Value: [Your Dropbox access token]"
            exit 1
          fi
          
          # Try AI_list.json first
          HTTP_CODE=$(curl -s -o "Finance Public/AI_list.json" -w "%{http_code}" \
            -X POST https://content.dropboxapi.com/2/files/download \
            --header "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"/Finance Public/AI_list.json\"}")
          
          # Check response for token expiration
          if [ "$HTTP_CODE" = "401" ]; then
            echo "❌ Error: Dropbox Access Token has expired (HTTP 401)"
            echo "Response content:"
            cat "Finance Public/AI_list.json" || echo "No response file"
            echo ""
            echo "To fix this:"
            echo "1. Go to https://www.dropbox.com/developers/apps"
            echo "2. Select your app or create a new one"
            echo "3. Generate a new access token"
            echo "4. Go to GitHub: Settings > Secrets and variables > Actions"
            echo "5. Update DROPBOX_ACCESS_TOKEN secret with the new token"
            exit 1
          fi
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to download AI_list.json (HTTP $HTTP_CODE), trying alternative..."
            # Try alternative path
            HTTP_CODE=$(curl -s -o "Finance Public/AI_list.json" -w "%{http_code}" \
              -X POST https://content.dropboxapi.com/2/files/download \
              --header "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
              --header "Dropbox-API-Arg: {\"path\": \"/Finance Public/AI  - AI.json\"}")
            
            if [ "$HTTP_CODE" = "401" ]; then
              echo "❌ Error: Dropbox Access Token has expired (HTTP 401)"
              echo "Response content:"
              cat "Finance Public/AI_list.json" || echo "No response file"
              echo ""
              echo "To fix this:"
              echo "1. Go to https://www.dropbox.com/developers/apps"
              echo "2. Select your app or create a new one"
              echo "3. Generate a new access token"
              echo "4. Go to GitHub: Settings > Secrets and variables > Actions"
              echo "5. Update DROPBOX_ACCESS_TOKEN secret with the new token"
              exit 1
            fi
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "Error: Failed to download from Dropbox (HTTP $HTTP_CODE)"
              echo "Response content:"
              cat "Finance Public/AI_list.json" || echo "No response file"
              exit 1
            fi
          fi
          
          # Verify it's valid JSON
          if ! python3 -m json.tool "Finance Public/AI_list.json" > /dev/null 2>&1; then
            echo "Error: Downloaded file is not valid JSON"
            echo "First 500 characters:"
            head -c 500 "Finance Public/AI_list.json"
            exit 1
          fi
          
          echo "Successfully downloaded AI_list.json from Dropbox"
      
      - name: Run catalog sync script
        run: |
          node scripts/sync_from_ai_list.js
      
      - name: Check for changes
        id: check_changes
        run: |
          git add "remake AI Catalog/js/smt.js"
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in catalog"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in catalog"
            git status --short
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "ai-catalog-sync-bot"
          git config user.email "actions@github.com"
          git commit -m "Auto-sync: Update AI catalog from AI_list.json - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git pull origin main --rebase || true
          git push origin main
      
      - name: Upload sync logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs
          path: |
            sync-*.log
          retention-days: 7
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ AI Catalog sync failed! Check the logs for details."

