name: Sync AI Catalog from AI_list.json

on:
  # Manual trigger
  workflow_dispatch:
  
  # Scheduled check every 6 hours
  schedule:
    - cron: '0 */6 * * *'

jobs:
  sync-catalog:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow writing to repository
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Download AI_list.json from Dropbox
        env:
          DROPBOX_ACCESS_TOKEN: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
        run: |
          mkdir -p "Finance Public"
          # Try AI_list.json first, then fallback to AI  - AI.json
          curl -X POST https://content.dropboxapi.com/2/files/download \
            --header "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"/Finance Public/AI_list.json\"}" \
            -o "Finance Public/AI_list.json" 2>/dev/null || \
          curl -X POST https://content.dropboxapi.com/2/files/download \
            --header "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"/Finance Public/AI  - AI.json\"}" \
            -o "Finance Public/AI_list.json" 2>/dev/null || \
          echo "Warning: Could not download from Dropbox, using existing file if available"
      
      - name: Run catalog sync script
        run: |
          node scripts/sync_from_ai_list.js
      
      - name: Check for changes
        id: check_changes
        run: |
          git add "remake AI Catalog/js/smt.js"
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in catalog"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in catalog"
            git status --short
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "ai-catalog-sync-bot"
          git config user.email "actions@github.com"
          git commit -m "Auto-sync: Update AI catalog from AI_list.json - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git pull origin main --rebase || true
          git push origin main
      
      - name: Upload sync logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs
          path: |
            sync-*.log
          retention-days: 7
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå AI Catalog sync failed! Check the logs for details."

